<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Lessons</title>

    <link rel="stylesheet" href="css/style.css" />

    <style>
      .group-header {
        cursor: pointer;
        user-select: none;
        margin-top: 24px;
        font-weight: bold;
      }

      .lesson-link {
        cursor: pointer;
        color: #0066cc;
        text-decoration: underline;
        display: block;
        margin: 6px 0;
      }

      .lesson-content {
        margin-left: 16px;
        margin-top: 16px;
        padding: 12px;
        border-left: 3px solid #ddd;
      }

      .exercise-link {
        margin-top: 16px;
        padding: 8px 12px;
        background: #0066cc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .exercise-link:hover {
        background: #004fa3;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Lessons</h1>
      <p>Select a lesson to read the explanation.</p>

      <div id="lesson-list"></div>

      <a href="index.html">← Back</a>
    </div>

    <script>
      /* =========================================================
         Robust BASE_PATH (works on GitHub Pages + locally)
         ========================================================= */
      const BASE_PATH = (() => {
        const scriptSrc = document.currentScript.src;
        const scriptDir = scriptSrc.substring(0, scriptSrc.lastIndexOf("/"));
        return scriptDir.replace(window.location.origin, "");
      })();

      /* =========================================================
         Render lesson list
         ========================================================= */
      function renderLessons(lessons) {
        const container = document.getElementById("lesson-list");
        container.innerHTML = "";

        const groupMap = {};

        lessons.forEach((lesson) => {
          const groups =
            Array.isArray(lesson.groups) && lesson.groups.length
              ? lesson.groups
              : ["other"];

          groups.forEach((group) => {
            if (!groupMap[group]) groupMap[group] = [];
            groupMap[group].push(lesson);
          });
        });

        Object.entries(groupMap).forEach(([group, items]) => {
          const header = document.createElement("div");
          header.className = "group-header";
          header.textContent = `▶ ${formatGroupName(group)}`;

          const groupDiv = document.createElement("div");
          groupDiv.style.display = "none";

          header.onclick = () => {
            const open = groupDiv.style.display === "block";
            groupDiv.style.display = open ? "none" : "block";
            header.textContent = `${open ? "▶" : "▼"} ${formatGroupName(group)}`;
          };

          items.forEach((lesson) => {
            const link = document.createElement("div");
            link.className = "lesson-link";
            link.textContent = lesson.title;
            link.onclick = () => loadLesson(lesson);
            groupDiv.appendChild(link);
          });

          container.appendChild(header);
          container.appendChild(groupDiv);
        });
      }

      /* =========================================================
         Load lesson HTML + hook exercise buttons
         ========================================================= */
      function loadLesson(lesson) {
        fetch(`${BASE_PATH}/lessons/${lesson.file}`)
          .then((res) => {
            if (!res.ok) throw new Error("Lesson not found");
            return res.text();
          })
          .then((html) => {
            document
              .querySelectorAll(".lesson-content")
              .forEach((el) => el.remove());

            const content = document.createElement("div");
            content.className = "lesson-content";
            content.innerHTML = html;

            /* Hook "Practice exercises →" buttons */
            content.querySelectorAll(".exercise-link").forEach((btn) => {
              btn.addEventListener("click", () => {
                const lessonId = btn.dataset.lesson;
                window.location.href = `${BASE_PATH}/exercises.html?lesson=${lessonId}`;
              });
            });

            document.querySelector(".container").appendChild(content);

            window.scrollTo({
              top: content.offsetTop - 20,
              behavior: "smooth",
            });
          })
          .catch((err) => {
            console.error(err);
            alert("Failed to load lesson.");
          });
      }

      /* =========================================================
         Group name display
         ========================================================= */
      function formatGroupName(key) {
        const map = {
          foundations: "Foundations",
          "verb-stems": "Verb Stems",
          nagara: "ながら",
          "nari-nari": "〜なり〜なり",
          location: "Location",
          other: "Other",
        };
        return map[key] || key;
      }

      /* =========================================================
         Load lessons index
         ========================================================= */
      fetch(`${BASE_PATH}/data/lessons.json`)
        .then((res) => {
          if (!res.ok) throw new Error("lessons.json not found");
          return res.json();
        })
        .then((data) => renderLessons(data))
        .catch((err) => {
          console.error(err);
          alert("Failed to load lessons list.");
        });
    </script>
  </body>
</html>
