<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Lessons</title>

    <link rel="stylesheet" href="css/style.css" />

    <style>
      .group-header {
        cursor: pointer;
        user-select: none;
        margin-top: 24px;
        font-weight: bold;
      }

      .lesson-content {
        display: none;
        margin-left: 16px;
        margin-top: 16px;
        padding: 12px;
        border-left: 3px solid #ddd;
      }

      .lesson-link {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        color: #0066cc;
        text-decoration: underline;
        display: block;
        margin: 6px 0;
        font: inherit;
        text-align: left;
      }

      .exercise-link {
        margin-top: 16px;
        padding: 8px 12px;
        background: #0066cc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .exercise-link:hover {
        background: #004fa3;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Lessons</h1>
      <p>Select a lesson to read the explanation.</p>

      <div id="lesson-list"></div>

      <a href="index.html">← Back</a>
    </div>

    <script>
      /* --------------------------------------------------
         BASE PATH (GitHub Pages–safe, bullet-proof)
         -------------------------------------------------- */
      const BASE_PATH =
        location.hostname === "rosendo1738.github.io"
          ? "/" + location.pathname.split("/")[1]
          : "";

      console.log("BASE_PATH:", BASE_PATH);

      /* --------------------------------------------------
         Render lesson list
         -------------------------------------------------- */
      function renderLessons(lessons) {
        const container = document.getElementById("lesson-list");
        container.innerHTML = "";

        const groupMap = {};

        lessons.forEach((lesson) => {
          const groups =
            Array.isArray(lesson.groups) && lesson.groups.length
              ? lesson.groups
              : ["other"];

          groups.forEach((group) => {
            if (!groupMap[group]) groupMap[group] = [];
            groupMap[group].push(lesson);
          });
        });

        Object.entries(groupMap).forEach(([group, items]) => {
          const header = document.createElement("div");
          header.className = "group-header";
          header.textContent = `▶ ${formatGroupName(group)}`;

          const groupDiv = document.createElement("div");
          groupDiv.style.display = "none";

          header.onclick = () => {
            const open = groupDiv.style.display === "block";
            groupDiv.style.display = open ? "none" : "block";
            header.textContent = `${open ? "▶" : "▼"} ${formatGroupName(group)}`;
          };

          items.forEach((lesson) => {
            const link = document.createElement("button");
            link.className = "lesson-link";
            link.type = "button";
            link.textContent = lesson.title;
            link.onclick = () => loadLesson(lesson, link);
            groupDiv.appendChild(link);
          });

          container.appendChild(header);
          container.appendChild(groupDiv);
        });
      }

      /* --------------------------------------------------
         Load lesson HTML
         -------------------------------------------------- */
      function loadLesson(lesson, anchorEl) {
        fetch(`${BASE_PATH}/lessons/${lesson.file}`)
          .then((res) => {
            if (!res.ok) throw new Error("Lesson not found");
            return res.text();
          })
          .then((html) => {
            document
              .querySelectorAll(".lesson-content")
              .forEach((el) => el.remove());

            const container = document.createElement("div");
            container.className = "lesson-content";

            // safety: strip scripts from lesson HTML
            container.innerHTML = html.replace(
              /<script[\s\S]*?>[\s\S]*?<\/script>/gi,
              "",
            );

            container.querySelectorAll(".exercise-link").forEach((btn) => {
              btn.onclick = () => {
                const lessonId = btn.dataset.lesson;
                const target = `${BASE_PATH}/exercises/exercise.html?exercise=${lessonId}`;

                console.log("Redirecting to:", target);
                window.location.href = target;
              };
            });

            anchorEl.after(container);
            container.style.display = "block";

            container.scrollIntoView({ behavior: "smooth", block: "start" });
          })
          .catch((err) => {
            alert("Failed to load lesson.");
            console.error(err);
          });
      }

      /* --------------------------------------------------
         Group name formatting
         -------------------------------------------------- */
      function formatGroupName(key) {
        const map = {
          foundations: "Foundations",
          "verb-stems": "Verb Stems",
          nagara: "ながら",
          "nari-nari": "〜なり〜なり",
          other: "Other",
        };
        return map[key] || key;
      }

      /* --------------------------------------------------
         Load lessons.json
         -------------------------------------------------- */
      fetch(`${BASE_PATH}/data/lessons.json`)
        .then((res) => {
          if (!res.ok) throw new Error("lessons.json not found");
          return res.json();
        })
        .then((data) => renderLessons(data))
        .catch((err) => {
          alert("Failed to load lessons list.");
          console.error(err);
        });
    </script>
  </body>
</html>
