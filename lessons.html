<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Lessons</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .group-header {
        cursor: pointer;
        user-select: none;
        margin-top: 24px;
        font-weight: bold;
      }

      .lesson-content {
        display: none;
        margin-left: 16px;
        margin-top: 8px;
      }

      .lesson-link {
        cursor: pointer;
        color: #0066cc;
        text-decoration: underline;
        display: block;
        margin: 6px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Lessons</h1>
      <p>Select a lesson to read the explanation.</p>

      <div id="lesson-list"></div>

      <a href="index.html">← Back</a>
    </div>

    <script>
      function renderLessons(lessons) {
        const container = document.getElementById("lesson-list");
        container.innerHTML = "";

        const groupMap = {};

        lessons.forEach((lesson) => {
          const groups =
            Array.isArray(lesson.groups) && lesson.groups.length
              ? lesson.groups
              : ["other"];

          groups.forEach((group) => {
            if (!groupMap[group]) groupMap[group] = [];
            groupMap[group].push(lesson);
          });
        });

        Object.entries(groupMap).forEach(([group, items]) => {
          const header = document.createElement("div");
          header.className = "group-header";
          header.textContent = `▶ ${formatGroupName(group)}`;

          const groupDiv = document.createElement("div");
          groupDiv.style.display = "none";

          header.onclick = () => {
            const open = groupDiv.style.display === "block";
            groupDiv.style.display = open ? "none" : "block";
            header.textContent = `${open ? "▶" : "▼"} ${formatGroupName(group)}`;
          };

          items.forEach((lesson) => {
            const link = document.createElement("div");
            link.className = "lesson-link";
            link.textContent = lesson.title;
            link.onclick = () => loadLesson(lesson);
            groupDiv.appendChild(link);
          });

          container.appendChild(header);
          container.appendChild(groupDiv);
        });
      }

      function loadLesson(lesson) {
        fetch(`lessons/${lesson.file}`)
          .then((res) => res.text())
          .then((html) => {
            const container = document.createElement("div");
            container.className = "lesson-content question";
            container.innerHTML = html;

            document
              .querySelectorAll(".lesson-content")
              .forEach((el) => el.remove());
            document.querySelector(".container").appendChild(container);
            container.style.display = "block";
            window.scrollTo({
              top: container.offsetTop - 20,
              behavior: "smooth",
            });
          });
      }

      function formatGroupName(key) {
        const map = {
          foundations: "Foundations",
          "verb-stems": "Verb Stems",
          nagara: "ながら",
          "nari-nari": "〜なり〜なり",
          other: "Other",
        };
        return map[key] || key;
      }

      fetch("data/lessons.json")
        .then((res) => res.json())
        .then((data) => renderLessons(data));
    </script>
  </body>
</html>
