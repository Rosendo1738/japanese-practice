<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Exercises</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      /* Group dropdown styling */
      .group-header {
        cursor: pointer;
        user-select: none;
        margin-top: 24px;
        display: flex;
        align-items: center;
        font-weight: bold;
      }

      .group-header span {
        margin-left: 6px;
        font-size: 0.9rem;
        color: #555;
      }

      .group-content {
        margin-left: 16px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Exercises</h1>
      <p>Select an exercise. Your saved progress is shown.</p>

      <button onclick="clearAllProgress()">üßπ Clear all progress</button>

      <!-- GROUPED EXERCISE LIST -->
      <div id="exercise-list"></div>

      <a href="index.html">‚Üê Back</a>
    </div>

    <script>
      /* ---------- PROGRESS ---------- */

      function loadProgress() {
        return JSON.parse(localStorage.getItem("progress") || "{}");
      }

      function clearAllProgress() {
        if (!confirm("Clear progress for ALL exercises?")) return;
        localStorage.removeItem("progress");
        renderExercises(window.exerciseIndex);
      }

      /* ---------- RENDERING ---------- */

      function renderExercises(exercises) {
        const container = document.getElementById("exercise-list");
        container.innerHTML = "";

        const progressData = loadProgress();

        // Build group ‚Üí exercises map
        const groupMap = {};

        exercises.forEach((ex) => {
          const groups =
            Array.isArray(ex.groups) && ex.groups.length
              ? ex.groups
              : ["other"];

          groups.forEach((group) => {
            if (!groupMap[group]) groupMap[group] = [];
            groupMap[group].push(ex);
          });
        });

        // Render each group as dropdown
        Object.entries(groupMap).forEach(([group, items]) => {
          const header = document.createElement("div");
          header.className = "group-header";
          header.innerHTML = `
            ‚ñ∂ ${formatGroupName(group)}
            <span>(${items.length})</span>
          `;

          const content = document.createElement("div");
          content.className = "group-content";

          const ul = document.createElement("ul");

          items.forEach((ex) => {
            const progress = progressData[ex.id];
            const progressText = progress
              ? ` (${progress.correct}/${progress.total})`
              : " (0/0)";

            const li = document.createElement("li");
            li.innerHTML = `
              <a href="exercises/exercise.html?exercise=${ex.id}">
                ${ex.title}
              </a>
              <span>${progressText}</span>
            `;
            ul.appendChild(li);
          });

          content.appendChild(ul);

          // Toggle logic
          header.onclick = () => {
            const isOpen = content.style.display === "block";
            content.style.display = isOpen ? "none" : "block";
            header.innerHTML = `
              ${isOpen ? "‚ñ∂" : "‚ñº"} ${formatGroupName(group)}
              <span>(${items.length})</span>
            `;
          };

          container.appendChild(header);
          container.appendChild(content);
        });
      }

      function formatGroupName(key) {
        const map = {
          "verb-stems": "Verb Stems",
          nagara: "„Å™„Åå„Çâ",
          "nari-nari": "„Äú„Å™„Çä„Äú„Å™„Çä",
          other: "Other",
        };
        return map[key] || key;
      }

      /* ---------- LOAD MANIFEST ---------- */

      fetch("data/exercises.json")
        .then((res) => res.json())
        .then((data) => {
          window.exerciseIndex = data;
          renderExercises(data);
        });
    </script>
  </body>
</html>
